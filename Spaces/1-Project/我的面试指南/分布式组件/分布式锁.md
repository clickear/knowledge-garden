---
date created: 2022-09-15
date modified: 2023-10-08
title: èµ„æ–™
---

## è¯„ä¼°æ ‡å‡†

### é—®é¢˜

- **é«˜å¯ç”¨é—®é¢˜**ï¼šæ— è®ºä½•æ—¶éƒ½è¦ä¿è¯é”æœåŠ¡çš„å¯ç”¨æ€§ï¼ˆè¿™æ˜¯ç³»ç»Ÿæ­£å¸¸æ‰§è¡Œé”æ“ä½œçš„åŸºç¡€ï¼‰ã€‚é›†ç¾¤ + è‡ªåŠ¨æ•…éšœè½¬ç§»
- **æ­»é”é—®é¢˜**ï¼šå®¢æˆ·ç«¯ä¸€å®šå¯ä»¥è·å¾—é”ï¼Œå³ä½¿é”ä½æŸä¸ªèµ„æºçš„å®¢æˆ·ç«¯åœ¨é‡Šæ”¾é”ä¹‹å‰å´©æºƒæˆ–è€…ç½‘ç»œä¸å¯è¾¾ï¼ˆè¿™æ˜¯é¿å…æ­»é”çš„è®¾è®¡åŸåˆ™ï¼‰ã€‚ redis: è¶…æ—¶è‡ªåŠ¨è§£é” + å®ˆæŠ¤è¿›ç¨‹è‡ªåŠ¨å»¶é•¿é”è¶…æ—¶æ—¶é—´  
    zk: è¿æ¥æ–­å¼€ï¼Œè‡ªåŠ¨é‡Šæ”¾
- **è„‘è£‚é—®é¢˜**ï¼šé›†ç¾¤åŒæ­¥æ—¶äº§ç”Ÿçš„æ•°æ®ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ–°çš„è¿›ç¨‹æœ‰å¯èƒ½æ‹¿åˆ°é”ï¼Œä½†ä¹‹å‰çš„è¿›ç¨‹ä»¥ä¸ºè‡ªå·±è¿˜æœ‰é”ï¼Œé‚£ä¹ˆå°±å‡ºç°ä¸¤ä¸ªè¿›ç¨‹æ‹¿åˆ°äº†åŒä¸€ä¸ªé”çš„é—®é¢˜ã€‚ (å¤§éƒ¨åˆ†èŠ‚ç‚¹æˆåŠŸæ‰ç®—æˆåŠŸï¼‰
    - redisä½¿ç”¨realockç®—æ³•ï¼Œ
    - zkå¤©ç„¶æ”¯æŒ
- **å¯é‡å…¥é—®é¢˜**: åœ¨å®¢æˆ·ç«¯æˆ–è€…é”çš„æ—¶å€™ï¼Œè®°å½•é”æ¬¡æ•°ï¼Œä¸å½“å‰çº¿ç¨‹ç»‘å®šï¼Œå¦‚TreadLocalå®ç°ï¼Œæˆ–è€…å°†çº¿ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒæŠ¥é”™åœ¨æ•°æ®åº“çš„å­—æ®µã€‚

### è®¾è®¡åŸåˆ™

- **äº’æ–¥æ€§**ï¼šå³åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒä¸‹ï¼Œå¯¹äºæŸä¸€å…±äº«èµ„æºï¼Œéœ€è¦ä¿è¯åœ¨åŒä¸€æ—¶é—´åªèƒ½ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹å¯¹è¯¥èµ„æºè¿›è¡Œæ“ä½œã€‚
- **é«˜å¯ç”¨**ï¼šä¹Ÿå°±æ˜¯å¯é æ€§ï¼Œé”æœåŠ¡ä¸èƒ½æœ‰å•ç‚¹é£é™©ï¼Œè¦ä¿è¯åˆ†å¸ƒå¼é”ç³»ç»Ÿæ˜¯é›†ç¾¤çš„ï¼Œå¹¶ä¸”æŸä¸€å°æœºå™¨é”ä¸èƒ½æä¾›æœåŠ¡äº†ï¼Œå…¶ä»–æœºå™¨ä»ç„¶å¯ä»¥æä¾›é”æœåŠ¡ã€‚
- **é”é‡Šæ”¾**ï¼šå…·å¤‡é”å¤±æ•ˆæœºåˆ¶ï¼Œé˜²æ­¢æ­»é”ã€‚å³ä½¿å‡ºç°è¿›ç¨‹åœ¨æŒæœ‰é”çš„æœŸé—´å´©æºƒæˆ–è€…è§£é”å¤±è´¥çš„æƒ…å†µï¼Œä¹Ÿèƒ½è¢«åŠ¨è§£é”ï¼Œä¿è¯åç»­å…¶ä»–è¿›ç¨‹å¯ä»¥è·å¾—é”ã€‚
- **å¯é‡å…¥**ï¼šä¸€ä¸ªèŠ‚ç‚¹è·å–äº†é”ä¹‹åï¼Œè¿˜å¯ä»¥å†æ¬¡è·å–æ•´ä¸ªé”èµ„æºã€‚

## è§£å†³æ–¹æ¡ˆ

### åŸºäºå…³ç³»å‹æ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”(æ‚²è§‚é”)

å…ˆæŸ¥è¯¢æ•°æ®åº“æ˜¯å¦å­˜åœ¨è®°å½•ï¼Œä¸ºäº†é˜²æ­¢å¹»è¯»å–ï¼ˆå¹»è¯»å–ï¼šäº‹åŠ¡ A æŒ‰ç…§ä¸€å®šæ¡ä»¶è¿›è¡Œæ•°æ®è¯»å–ï¼Œè¿™æœŸé—´äº‹åŠ¡ B æ’å…¥äº†ç›¸åŒæœç´¢æ¡ä»¶çš„æ–°æ•°æ®ï¼Œäº‹åŠ¡ A å†æ¬¡æŒ‰ç…§åŸå…ˆæ¡ä»¶è¿›è¡Œè¯»å–æ—¶ï¼Œå‘ç°äº†äº‹åŠ¡ B æ–°æ’å…¥çš„æ•°æ® ï¼‰é€šè¿‡æ•°æ®åº“è¡Œé” select for update é”ä½è¿™è¡Œæ•°æ®ï¼Œç„¶åå°†æŸ¥è¯¢å’Œæ’å…¥çš„ SQL åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æäº¤ã€‚

`**select id from order where order_id = xxx for update**`

#### å»¶ä¼¸é—®é¢˜ï¼Œ[[äº‹åŠ¡éš”ç¦»çº§åˆ«]]

#### åŸºäºä¹è§‚é”çš„æ–¹å¼å®ç°åˆ†å¸ƒå¼é”.( ä¸€èˆ¬éœ€é‡è¯•)ã€‚

select for update æ˜¯æ‚²è§‚é”ï¼Œä¼šä¸€ç›´é˜»å¡ç›´åˆ°äº‹åŠ¡æäº¤ï¼Œæ‰€ä»¥ä¸ºäº†ä¸äº§ç”Ÿé”ç­‰å¾…è€Œæ¶ˆè€—èµ„æºï¼Œä½ å¯ä»¥åŸºäºä¹è§‚é”çš„æ–¹å¼æ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œæ¯”å¦‚åŸºäºç‰ˆæœ¬å·çš„æ–¹å¼ï¼Œé¦–å…ˆåœ¨æ•°æ®åº“å¢åŠ ä¸€ä¸ª int å‹å­—æ®µ verï¼Œç„¶ååœ¨ SELECT åŒæ—¶è·å– ver å€¼ï¼Œæœ€ååœ¨ UPDATE çš„æ—¶å€™æ£€æŸ¥ ver å€¼æ˜¯å¦ä¸ºä¸ç¬¬ 2 æ­¥æˆ–å¾—åˆ°çš„ç‰ˆæœ¬å€¼ç›¸åŒ

```sql
## SELECT åŒæ—¶è·å– ver å€¼
select amount, old_ver from order where order_id = xxx
## UPDATE çš„æ—¶å€™æ£€æŸ¥ ver å€¼æ˜¯å¦ä¸ç¬¬ 2 æ­¥è·å–åˆ°çš„å€¼ç›¸åŒ
update order set ver = old_ver + 1, amount = yyy where order_id = xxx and ver = old_ver;
```

#### åŸºäºå”¯ä¸€ç´¢å¼•åˆ›å»ºé”

é€šè¿‡åˆ›å»ºæ•°æ®åº“å”¯ä¸€ç´¢å¼•ï¼Œæ’å…¥æˆåŠŸï¼Œè·å¾—é”ã€‚å¤±è´¥ï¼Œåˆ™æœªè·å¾—

### åŸºäºåˆ†å¸ƒå¼ç¼“å­˜å®ç°åˆ†å¸ƒå¼é”(APæ¨¡å‹)

å› ä¸ºæ•°æ®åº“çš„æ€§èƒ½é™åˆ¶äº†ä¸šåŠ¡çš„å¹¶å‘é‡ï¼Œæ‰€ä»¥é’ˆå¯¹â€œ 618 å’ŒåŒ 11 å¤§ä¿ƒâ€ç­‰è¯·æ±‚é‡å‰§å¢çš„åœºæ™¯ï¼Œä½ è¦å¼•å…¥åŸºäºç¼“å­˜çš„åˆ†å¸ƒå¼é”ï¼Œè¿™ä¸ªæ–¹æ¡ˆå¯ä»¥é¿å…å¤§é‡è¯·æ±‚ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œæé«˜ç³»ç»Ÿçš„å“åº”èƒ½åŠ›ã€‚

`SET lock_key unique_value NX PX 10000`

- lock_key å°±æ˜¯ key é”®ï¼›
- unique_value æ˜¯å®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€çš„æ ‡è¯†ï¼›**é‡Šæ”¾æ—¶ï¼Œéœ€è¦åˆ¤æ–­ï¼Œæ˜¯å¦æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯**
- NX ä»£è¡¨åªåœ¨ lock_key ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹ lock_key è¿›è¡Œè®¾ç½®æ“ä½œï¼›
- PX 10000 è¡¨ç¤ºè®¾ç½® lock_key çš„è¿‡æœŸæ—¶é—´ä¸º 10sï¼Œè¿™æ˜¯**ä¸ºäº†é¿å…å®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸è€Œæ— æ³•é‡Šæ”¾é”**ã€‚  
ä¸»è¦ä»¥ä¸‹2ä¸ªæ–¹æ¡ˆã€‚
- setNX + Luaè„šæœ¬
- redisson + RLockå¯é‡å…¥é”(æ¨èä½¿ç”¨)

#### redisæ™®é€šå®ç°

> [!TIP] æŠ€å·§ğŸ’¡  
>  setnx æŒ‡ä»¤ + expire æŒ‡ä»¤ã€‚
>  1. ä¸šåŠ¡æ‰§è¡Œå¤ªé•¿ï¼Œéœ€è¦å¢åŠ å®ˆæŠ¤è¿›ç¨‹ã€‚
>  2. é›†ç¾¤åŒæ­¥æœªåŠæ—¶é—®é¢˜

åŠ é”: setnx æŒ‡ä»¤ + expire æŒ‡ä»¤ã€‚

2.6.12ä¹‹å‰ï¼Œéœ€è¦ä½¿ç”¨luaã€‚ä¿è¯åŸå­æ€§ã€‚ setnxä¸æ”¯æŒexpireè®¾ç½®å¤±æ•ˆæ—¶é—´ï¼Œæ‰€ä»¥åªèƒ½ç”¨luaä¿è¯åŸå­æ€§ã€‚

2.6.12ä¹‹åï¼Œæ”¯æŒåŸå­æ€§ã€‚setå‘½ä»¤ï¼Œæ”¯æŒ NX å’Œ EXPIREå‚æ•°ã€‚

è§£é”:

åˆ¤æ–­åŠ é”å’Œè§£é”æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œéœ€è¦ä½¿ç”¨luaä¿è¯åŸå­æ€§

```lua
// é‡Šæ”¾é”æ—¶ï¼Œå…ˆæ¯”è¾ƒ unique_value æ˜¯å¦ç›¸ç­‰ï¼Œé¿å…é”çš„è¯¯é‡Šæ”¾
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end
```

ä¼˜ç‚¹:

1. æ€§èƒ½é«˜æ•ˆ
2. å®ç°æ–¹ä¾¿ï¼Œä½¿ç”¨redisï¼Œå¾ˆå¤šé¡¹ç›®éƒ½ä¼šä½¿ç”¨redisä½œä¸ºç¼“å­˜
3. é¿å…å•ç‚¹æ•…éšœï¼ˆå› ä¸º Redis æ˜¯è·¨é›†ç¾¤éƒ¨ç½²çš„ï¼Œè‡ªç„¶å°±é¿å…äº†å•ç‚¹æ•…éšœï¼‰

ç¼ºç‚¹:

1. ä¸åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œ
    
    1. å¦‚Aé”æœªå¤„ç†å®Œï¼Œä½†æ˜¯å·²ç»è¶…æ—¶äº†ã€‚è¿™æ˜¯Bé”åˆæ¥ç”³è¯·
    2. æ–¹æ¡ˆ: å¢åŠ å®ˆæŠ¤è¿›ç¨‹ï¼Œå®šæ—¶åˆ·æ–°è¿‡æœŸæ—¶é—´ï¼Œå¢åŠ äº†å¤æ‚åº¦
2. Redis é›†ç¾¤çš„æ•°æ®åŒæ­¥æœºåˆ¶ã€‚
    
    > ç”±äº Redis é›†ç¾¤æ•°æ®åŒæ­¥åˆ°å„ä¸ªèŠ‚ç‚¹æ—¶æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœåœ¨ Redis ä¸»èŠ‚ç‚¹è·å–åˆ°é”åï¼Œåœ¨æ²¡æœ‰åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹æ—¶ï¼ŒRedis ä¸»èŠ‚ç‚¹å®•æœºäº†ï¼Œæ­¤æ—¶æ–°çš„ Redis ä¸»èŠ‚ç‚¹ä¾ç„¶å¯ä»¥è·å–é”ï¼Œæ‰€ä»¥å¤šä¸ªåº”ç”¨æœåŠ¡å°±å¯ä»¥åŒæ—¶è·å–åˆ°é”  
    rediså®˜æ–¹å¤„ç†ï¼ŒRedlockç®—æ³•

```java
   @Resource
    private StringRedisTemplate stringRedisTemplate;

    @SuppressWarnings("all")
    public boolean lock(String key, String value, long second) {
        return stringRedisTemplate.execute((RedisCallback<Boolean>) connection -> {
            return connection.set(key.getBytes(StandardCharsets.UTF_8),
                    value.getBytes(StandardCharsets.UTF_8),
                    Expiration.seconds(second), RedisStringCommands.SetOption.ifAbsent());
        });
    }
    public boolean release(String key, Object requestId) {
        RedisScript<Long> script = new DefaultRedisScript<>(
                "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end", Long.class);
        final Long result = stringRedisTemplate.execute(script, Collections.singletonList(key), requestId);
        return Objects.equals(result, 1L);
    }
```

#### redis Redlockç®—æ³•

Redlock ç®—æ³•çš„åŸºæœ¬æ€è·¯ï¼Œæ˜¯è®©å®¢æˆ·ç«¯å’Œå¤šä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹ä¾æ¬¡è¯·æ±‚ç”³è¯·åŠ é”ï¼Œå¦‚æœå®¢æˆ·ç«¯èƒ½å¤Ÿå’ŒåŠæ•°ä»¥ä¸Šçš„å®ä¾‹æˆåŠŸåœ°å®ŒæˆåŠ é”æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºï¼Œå®¢æˆ·ç«¯æˆåŠŸåœ°è·å¾—åˆ†å¸ƒå¼é”ï¼Œå¦åˆ™åŠ é”å¤±è´¥ã€‚

**æˆ‘ä»¬å‡è®¾ç›®å‰æœ‰ N ä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹ï¼Œ**Â å®¢æˆ·ç«¯å…ˆæŒ‰é¡ºåºä¾æ¬¡å‘ N ä¸ª Redis å®ä¾‹æ‰§è¡ŒåŠ é”æ“ä½œã€‚è¿™é‡Œçš„åŠ é”æ“ä½œå’Œåœ¨å•å®ä¾‹ä¸Šæ‰§è¡Œçš„åŠ é”æ“ä½œä¸€æ ·ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRedlock ç®—æ³•è®¾ç½®äº†åŠ é”çš„è¶…æ—¶æ—¶é—´ï¼Œä¸ºäº†é¿å…å› ä¸ºæŸä¸ª Redis å®ä¾‹å‘ç”Ÿæ•…éšœè€Œä¸€ç›´ç­‰å¾…çš„æƒ…å†µã€‚

å½“å®¢æˆ·ç«¯å®Œæˆäº†å’Œæ‰€æœ‰ Redis å®ä¾‹çš„åŠ é”æ“ä½œä¹‹åï¼Œå¦‚æœæœ‰è¶…è¿‡åŠæ•°çš„ Redis å®ä¾‹æˆåŠŸçš„è·å–åˆ°äº†é”ï¼Œå¹¶ä¸”æ€»è€—æ—¶æ²¡æœ‰è¶…è¿‡é”çš„æœ‰æ•ˆæ—¶é—´ï¼Œé‚£ä¹ˆå°±æ˜¯åŠ é”æˆåŠŸ

```java
Config config = new Config();
config.useSentinelServers().addSentinelAddress("127.0.0.1:6369","127.0.0.1:6379", "127.0.0.1:6389")
        .setMasterName("masterName")
        .setPassword("password").setDatabase(0);
RedissonClient redissonClient = Redisson.create(config);
// è¿˜å¯ä»¥getFairLock(), getReadWriteLock()
RLock redLock = redissonClient.getLock("REDLOCK_KEY");
boolean isLock;
try {
    isLock = redLock.tryLock();
    // 500msæ‹¿ä¸åˆ°é”, å°±è®¤ä¸ºè·å–é”å¤±è´¥ã€‚10000mså³10sæ˜¯é”å¤±æ•ˆæ—¶é—´ã€‚
    isLock = redLock.tryLock(500, 10000, TimeUnit.MILLISECONDS);
    if (isLock) {
        //TODO if get lock success, do something;
    }
} catch (Exception e) {
} finally {
    // æ— è®ºå¦‚ä½•, æœ€åéƒ½è¦è§£é”
    redLock.unlock();
}
```

å¯é‡å…¥: å®¢æˆ·ç«¯è®°å½•é”æ¬¡æ•°ã€‚

é«˜å¯ç”¨: å®ˆæŠ¤çº¿ç¨‹ï¼Œå»¶è¿Ÿçº¿ç¨‹ã€‚ å¤§éƒ¨åˆ†redisåŠ è§£é”æˆåŠŸï¼Œæ‰ç®—æˆåŠŸ

### åŸºäº [[Zookeeper]] å®ç°åˆ†å¸ƒå¼é”(APæ¨¡å‹)

> [!TIP] æŠ€å·§ğŸ’¡  
> ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œç›‘å¬watchã€‚å°†æœ€å°çš„èŠ‚ç‚¹è¿›è¡ŒåŠ é”ã€‚

1. åœ¨å®¢æˆ·ç«¯ç«¯å£åï¼Œä¸´æ—¶èŠ‚ç‚¹è‡ªåŠ¨é‡Šæ”¾ã€‚å…¶å®ƒèŠ‚ç‚¹å°±å¯ä»¥è·å–åˆ°é”
2. createä¸´æ—¶èŠ‚ç‚¹æ—¶ï¼Œå¦‚æœå·²ç»å­˜åœ¨ä¼šæŠ¥é”™ã€‚(å”¯ä¸€æ€§)
3. zkçš„é›†ç¾¤æ˜¯**é«˜å¯ç”¨**çš„ï¼Œåªè¦åŠæ•°ä»¥ä¸Šçš„æˆ–è€…ï¼Œå°±å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡äº†

```java
public void sharedReentrantLock() throws Exception {
    // åˆ›å»ºå¯é‡å…¥é”
    InterProcessLock lock = new InterProcessMutex(client, lockPath);
    // lock2 ç”¨äºæ¨¡æ‹Ÿå…¶ä»–å®¢æˆ·ç«¯
    InterProcessLock lock2 = new InterProcessMutex(client2, lockPath);
    // lock è·å–é”
    lock.acquire();
    try {
        // lock ç¬¬äºŒæ¬¡è·å–é”
        lock.acquire();
        try {
            // lock2 è¶…æ—¶è·å–é”, å› ä¸ºé”å·²ç»è¢« lock å®¢æˆ·ç«¯å ç”¨, æ‰€ä»¥è·å–å¤±è´¥, éœ€è¦ç­‰ lock é‡Šæ”¾
            Assert.assertFalse(lock2.acquire(2, TimeUnit.SECONDS));
        } finally {
            lock.release();
        }
    } finally {
        // é‡å…¥é”è·å–ä¸é‡Šæ”¾éœ€è¦ä¸€ä¸€å¯¹åº”, å¦‚æœè·å– 2 æ¬¡, é‡Šæ”¾ 1 æ¬¡, é‚£ä¹ˆè¯¥é”ä¾ç„¶æ˜¯è¢«å ç”¨, å¦‚æœå°†ä¸‹é¢è¿™è¡Œä»£ç æ³¨é‡Š, é‚£ä¹ˆä¼šå‘ç°ä¸‹é¢çš„ lock2 è·å–é”å¤±è´¥
        lock.release();
    }
    // åœ¨ lock é‡Šæ”¾å, lock2 èƒ½å¤Ÿè·å–é”
    Assert.assertTrue(lock2.acquire(2, TimeUnit.SECONDS));
    lock2.release();
}
```

# èµ„æ–™

- [](https://book.clickear.top/%E6%8B%89%E5%8B%BE_%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E9%9D%A2%E8%AF%95%E7%B2%BE%E8%AE%B2/06%20%7C%20%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD%EF%BC%8C%E5%A6%82%E4%BD%95%E5%9B%9E%E7%AD%94%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9F.html)[https://book.clickear.top/æ‹‰å‹¾_æ¶æ„è®¾è®¡é¢è¯•ç²¾è®²/06](https://book.clickear.top/%E6%8B%89%E5%8B%BE_%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E9%9D%A2%E8%AF%95%E7%B2%BE%E8%AE%B2/06) | åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚ä½•å›ç­”é”çš„å®ç°åŸç†ï¼Ÿ.html
