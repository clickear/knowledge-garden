
# 常青笔记
+ 一般而言，不推荐副本数超过当前的节点数，因为当副本数据超过节点数时，就会出现同一个节点存在多个副本的情况。当这个节点故障时，上面的多个副本就都受到影响了
+ 当 W + R > N 时，可以实现强一致性。另外，如何设置 N、W、R 值，取决于我们想优化哪方面的性能。比如，N 决定了副本的冗余备份能力；如果设置 W = N，读性能比较好；如果设置 R = N，写性能比较好；如果设置 W = (N + 1) / 2、R = (N + 1) / 2，容错能力比较好，能容忍少数节点（也就是 (N - 1) / 2）的故障




# 重要摘要


## Quorum NWR 的三要素
### N
N 表示副本数，又叫做复制因子（Replication Factor）。也就是说，N 表示集群中同一份数据有多少个副本。
![](http://image.clickear.top/20220129113602.png)

在这个三节点的集群中，DATA-1 有 2 个副本，DATA-2 有 3 个副本，DATA-3 有 1 个副本。也就是说，副本数可以不等于节点数，不同的数据可以有不同的副本数

### W
W，又称写一致性级别（Write Consistency Level），表示成功完成 W 个副本更新，才完成写操作

influxDB 企业版，支持“any、one、quorum、all”4 种写一致性级别，具体的含义是这样的。
+ any：任何一个节点写入成功后，或者接收节点已将数据写入 Hinted-handoff 缓存（也就是写其他节点失败后，本地节点上缓存写失败数据的队列）后，就会返回成功给客户端。
+ one：任何一个节点写入成功后，立即返回成功给客户端，不包括成功写入到 Hinted-handoff 缓存。
+ quorum：当大多数节点写入成功后，就会返回成功给客户端。此选项仅在副本数大于 2 时才有意义，否则等效于 all。
+ all：仅在所有节点都写入成功后，返回成功。.

### R
R，又称读一致性级别（Read Consistency Level），表示读取一个数据对象时需要读 R 个副本。你可以这么理解，读取指定数据时，要读 R 副本，然后返回 R 个副本中最新的那份数据.



## 组合效果
关于 NWR 需要你注意的是，N、W、R 值的不同组合，会产生不同的一致性效果，具体来说，有这么两种效果：
+ 当 W + R > N 的时候，对于客户端来讲，整个系统能保证强一致性，一定能返回更新后的那份数据。
+ 当 W + R < N 的时候，对于客户端来讲，整个系统只能保证最终一致性，可能会返回旧数据。





”为什么只需要备份数据到部分节点，不需要备份到所有节点“，因为如果是AP系统，所以为了提升效率，备份数据到N个副本就可以认为是数据写入成功了，整个系统因为是最终一致性，系统内部会异步同步节点之间的数据，所以最终所有节点上的数据肯定会一致的，另外工程实践里N>=3, 是因为冗余数据是保证可靠性的手段，如果N=2，那么损失一个节点就退化为单节点了。