---
date created: 2022-09-08
date modified: 2022-09-08
title: 舌尖-瑞幸门店服务设计-首页推荐门店
---

## 背景

整理舌尖/瑞幸门店服务设计经验，用作我们方案设计的参考。

## 需求

用户进入小程序/app首页，根据业务过滤规则，自动推荐一家门店。

业务过滤规则包括：

- 取餐模式：自提，外送
- 距离：当取餐模式为自提时，取离用户当前坐标最近的门店。当取餐模式为外送时，取离用户默认配送地址坐标距离最近的门店
- 范围：用户当前坐标5公里范围内的门店
- 门店状态：营业中，配送中
- 用户习惯：用户常用下单门店

### 相关原型

**瑞幸-到店取：**  
![](http://image.clickear.top/20220908180004.png)

**瑞幸-幸运送**

![](http://image.clickear.top/20220908180027.png)  
**舌尖-自提**  
![Uploading file…zo9do]()

**舌尖-外送**  
![](http://image.clickear.top/20220908180106.png)

![](http://wiki.qudian.com/download/attachments/72886053/image2022-8-16%2010%3A21%3A11.png?version=1&modificationDate=1660628080000&api=v2)

**舌尖-外送-快递**  
![Uploading file…70z4a]()

## 方案一：Redis geo数据结构

### Redis geo介绍

![](http://image.clickear.top/20220908180143.png)

### 缓存设计

|      s    |         值                                     |         备注                                     |
| :------- | :------------------------------------------ | ------------------------------------------ |
| key      | shop_city_brand_arrive_110100_20200000003   | 代表北京市下所有支持自提的舌尖工坊品牌门店 |
|          | shop_city_brand_dispatch_110100_20200000003 | 代表北京市下所有支持外送的舌尖工坊品牌门店 |
| value    | 门店编号                                    |                                            |
| 过期时间 | 3天                                         |                                            |

### 缓存数据初始化

**核心指令**  
![](http://image.clickear.top/20220908180600.png)

使用Redis Geo 指令 geoadd 增加一家北京市自提的舌尖工坊品牌门店：

_redis> geoadd shop_city_brand_arrive_110100_20200000003 116.48105 39.996794 门店编号_

geoadd 指令支持批量增加。

### 数据一致性设计

当出现以下情况时，清除相应缓存：

- 门店开业/停业
- 已开业门店取餐模式变更
- 已开业门店经纬度变更

缓存清除后，重新查询时，需要更新缓存，此时需要考虑查询的并发度，可以使用分布式锁，限制同时只有一个线程在更新缓存。

### 查询首页推荐门店逻辑

**核心指令**  
![](http://image.clickear.top/20220908180637.png)

使用 Redis Geo 指令 georadius 查询附近的门店：

__redis>_ georadius shop_city_brand_arrive_110100_20200000003 116.514202 39.905409 20 km withdist count 10 asc_

以用户当前经纬度为中心，查找半径 20km 内的门店编号列表，数量10家，按距离从近到远排序。

实际应用时，将半径和数量配置在配置中心。

**查询流程图**

![](http://image.clickear.top/20220908180656.png)

入参用户经纬度是必传，如果为空，则不能用Redis geo查询。

极端情况下，遍历完门店编号列表后，可能没有找到门店，此时在业务上降级为查找城市门店。

## 方案二：将门店经纬度转换为geohash编码

### 经纬度geohash编码介绍

效果：将经纬度编码为一个字符串。编码字符串相同的经纬度，代表在同一块矩形区域内，区域大小取决于编码精度

好处：在查询同一矩形区域内的经纬度场景下，查询性能高

编码过程：

- 将经纬度编码为二进制数
- 将二进制数使用base32编码为字符串

参考资料：

[https://juejin.cn/post/6844903842480390151](https://juejin.cn/post/6844903842480390151)

[https://www.cnblogs.com/LBSer/p/3310455.html](https://www.cnblogs.com/LBSer/p/3310455.html)

### 缓存设计

![](http://image.clickear.top/20220908180834.png)

 

### 缓存数据初始化

门店在指定经纬度时，自动计算Geohash11和Geohash13编码，并存放在数据库表中保存。

相同geohash编码的门店，会放在同一个Redis key中。

### 数据一致性设计

当出现以下情况时，清除相应缓存：

- 门店基础信息变更
- 门店开业/停业

缓存清除后，重新查询时，需要更新缓存，此时需要考虑查询的并发度，可以使用分布式锁，限制同时只有一个线程在更新缓存。

### 缓存更新实现

按门店的geohash编码字段，重新查询数据库，然后更新对应的缓存

### 查询到店取推荐门店逻辑

![](http://image.clickear.top/20220908180911.png)

**九宫格**

![](http://image.clickear.top/20220908180923.png)

### 进一步优化

查询推荐门店的逻辑包括计算九宫格，取九宫格内所有门店，按业务需求过滤出符合条件的门店，是一个复杂计算的过程，因此计算结果可以考虑放入到Redis中。

#### 缓存设计

![](http://image.clickear.top/20220908180800.png)  
 

#### 数据一致性设计

当出现以下情况时，清除相应缓存：

- 与门店推荐逻辑相关的字段发生变更，比如取餐模式，营业时间等
- 门店经纬度变更

缓存清除后，重新查询时，需要更新缓存，此时需要考虑查询的并发度，可以使用分布式锁，限制同时只有一个线程在更新缓存。

## 方案对比

![](http://image.clickear.top/20220908181022.png)  
结论：首页匹配门店采用**方案二**是较优的。
