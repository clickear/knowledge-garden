---
date created: 2022-09-08
date modified: 2022-09-08
title: 舌尖-瑞幸门店服务设计-门店下单
---

## 创建订单时序图

![](http://image.clickear.top/20220908182215.png)

## 分布式事务方案

下单操作对一致性要求较高，最终一致性并不适用下单场景，原因如下：

- 假如用户下单成功后，锁定优惠券的mq没有消费及时，用户可能会再次使用该优惠券，会造成一些较严重问题。
- 需要人工干预进行数据修复，及时性及效率不高。

使用saga模式：

- 订单系统作为事务管理者，负责分布式事务统一调度，保证数据一致性
- 关联系统作为事务参与者，需要提供取消rpc

![](http://image.clickear.top/20220908182228.png)

## 长事务问题

下单流程存在很多数据库事务内穿插多个RPC 同步调用，导致事务提交缓慢，连接池被占用，事务线程无法释放。订单核心流程同时需要保证订单库，咖啡券，库存等系统数据完整统一。其中任何环节异常，都需要保证其他系统状态一致。

优化方案：  
![Uploading file…noh4i]()
