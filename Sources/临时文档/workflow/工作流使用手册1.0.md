---
date created: 2022-09-13
date modified: 2022-09-13
title: 任务拆解
---

## 工作流简介

### 什么是工作流?

所谓工作流引擎是指workflow作为应用系统的一部分，并为之提供对各应用系统有决定作用的根据角色、分工和条件的不同决定信息传递路由、内容等级等核心解决方案。

### 功能特性

- 支持审批、驳回、撤销操作
- 支持会签(即多实例中的人需要全部审批完成)、抢签(有1人审批完成即可)
- 支持单节点多实例串行/并行功能(即一个节点可以有多个节点实例)
- 组织接入支持钉钉ID和QD fadongxiauth接入
- 支持评论功能
- 支持钉钉通知，流程审批、驳回等消息都会发送钉钉消息

### 工作流术语

- app应用
    
    > 即流程定义的集合，可认为是流程定义的分类
    
- 流程定义和节点定义
    
    > _一个流程的步骤说明，比如提交申请 —> 部门经理 —> 总经理 这个请假流程，申请人王三发起提交申请，李四作为部门经理进行审批，审批完成后，此申请到达下一级总经理王五，进行审批。这整个流程说明其实就是流程定义_
    >
    > 节点定义，就是流程定义上的一个步骤。比如 提交申请 —> 部门经理 —> 总经理 为一个流程定义，而提交申请、部门经理、总经理为一个个节点定义。
    
- 流程定义key和节点定义key
    
    > 一个流程定义对应的唯一key。建议加上自己的业务系统标识 如 HRM_EMAIL
    >
    > 节点定义key，即一个节点定义对应的key，一个流程定义下的节点定义key必须唯一。注意不能设置为
    
- 流程实例和节点实例(有些说明会为任务实例，其实是同一个概念)
    
    > 流程实例 即为流程定义的一个实例化，就是说 提交申请 —> 部门经理 —> 总经理 是一个流程定义，提交了一个请假流程，就有1个新的流程实例，对应的，到哪个节点，就会生成相应的节点实例。类比关系为 编程中 class 和实例 的概念。创建流程实例就是 new 的过程。
    
- 节点定义和节点实例的数量对应关系
    
    > 1个流程实例，在未到达之前之前不会创建节点实例。
    >
    > 提交申请(并行、1个审批人) —> 部门经理(并行、2个审批人) —> 总经理 (并行、1个审批人)
    >
    > 创建了一个流程实例之后，流程会自动流转到 提交节点，此时会创建1个节点实例和1个提交申请节点的节点实例。
    >
    > 提交申请节点审批之后，会自动到达部门经理节点，此时的节点实例为3个，1个是 提交申请节点实例，2个是部门经理实例(由于审批人有2个，同一个节点会创建2个节点实例)
    
- 流程上下文变量
    
    > 流程上下文，其实是指每一个流程实例都会保存一些变量值。流程引擎会注入和获取这些值使用。
    
- 申请人、提交人
    
    > 可能存在一种情况，如离职表单，代替申请人提交，此时走的上级领导应该是按照 申请人来走，而不是提交人的情况。这时申请人与提交人不同。这种情况下，只需要在流程上下文中，注入 **applyUserId** 或者 **applyDIngtalkId** 区别详见 组织关系接入说明
    

## 快速入门

### 时序图

![](http://image.clickear.top/20220913122615.png)

### 使用步骤

1. 设计表单(可选)
2. 设计工作流流程定义
3. 节点相关配置(任务配置(可选)、审批人配置、通知配置(可选)、回调配置(可选))
4. 使用流程(创建流程实例 —> 审批流程实例等操作)

### 快速入门流程说明

> 这里以请假单为例，该表单的功能为，全部审批通过之后，考勤系统自动添加请假时数。要注意的是，考勤系统对应工作流来说，是一个业务系统，添加请假时数属于业务行为。工作流只进行接口回调，具体回调的接口，做了什么，由业务系统决定。

1. 创建表单定义
2. 创建流程定义
3. 设置表单关联
4. 关联表单定义和流程定义

### [1. 设计表单定义](https://workflowtest.qufenqi.com/flowable-modeler/#/forms)

![](http://image.clickear.top/20220913122642.png)

#### 表单配置清单

- 表单定义KEY QDLeaveTestForm
- 表单字段列表

使用步骤:

1. 创建表单
2. 根据配置清单中的字段列表进行拖拽控件，并设置值

根据字段类型，拖拽相应控件，并设置id(需要勾选 覆盖id)。

#### 支持表单类型

- Text: 渲染为文本框
- Multiline text: 渲染为多行文本框
- Number: 渲染为只允许数字值的文本框
- Dropdown: 渲染为复选框
- Date: 渲染为日期框
- Dropdown: 渲染为下拉选择框，候选值由字段定义配置
- Radio buttons: 渲染为单选按钮，候选值由字段定义配置
- People: 渲染为选人框，可以选择用户身份表中的用户
- Upload: 渲染为上传框

### 设计流程定义

![](http://image.clickear.top/20220913122708.png)

![](http://wiki.qudian.com/download/attachments/38234935/QdLeaveFormProcess.png?version=1&modificationDate=1568200793000&api=v2)

#### 流程配置相关清单

##### 流程定义清单

![](http://image.clickear.top/20220913122734.png)

#### 创建流程定义

> 1.1 根据流程定义清单，创建流程定义。设置好 **流程定义KEY** 、**流程定义名称** 和 **appKey**的值。
>
> 1.2 根据需求，配置回调配置和通知配置

#### 创建节点定义

> 根据节点定义清单，拖拽 开始节点 —> 上级领导审批节点 —> 经理审批节点 —> 结束节点 ，并设置相关的配置、审批人设置

##### 节点相关配置

> 流程节点相关配置

##### 1. 任务配置

> 支持 自动跳过、拒绝策略配置

##### 2. 审批人配置

> 支持 固定审批人、申请人、提交人、API接口。
>
> > 1、固定审批人：一个流程可以有多个流程实例，但是这个流程的所有流程实例的节点审批人是一样的，看起来像是固定人员；审批人需要业务方确定好；  
> > 2、审批角色：同一流程的不同流程实例，有可能是不同人发起的，假如需要审批人的leader审批，那么不同发起人的leader是不同的，这一类我们抽离成「角色」这一个概念；  
> > 3、提交人：流程实例的发起者；注意与「申请人」区分；  
> > 4、申请人：流程实例的是所服务的对象；如，「张三」为「李四」提交了一个「邮件组加入申请」，那么「张三」是提交人，「李四」是申请人；  
> > 5、自选：还未实现，不要勾选这个选项；  
> > 6、表单控件：还未实现，不要勾选这个选项；  
> > 7、API：需要通过第三方接口查询节点审批人；

> 固定审批人配置可以在流程定义时配置好；
>
> > QAQ：如何进入节点审批人配置？  
> > 1：点击节点，下方出现✏️图标按钮；点击按钮进入节点配置  
> > ![](http://image.clickear.top/20220913122757.png)

> 接口获取审批人
>
> > QAQ:接口返回格式要求？

```
// 这里的 dingtalk_user_id为订单id
{
   "code":0,
    "data": [
     {"dingtalk_user_id": ""}
	, {"user_id": ""}
    , {"dingtalk_id": ""}
   ]
   
}
```

> 如何找到对应的审批人?
>
> > 可以通过人名搜索（目前只针对QD人员），如下图所示：  
> > ![](http://image.clickear.top/20220913122807.png)
  
> > 1、输入人名  
> > 2、输入框下面会出现搜索结果，点击对应人员，就能添加到审批人；如果没有对应人员出现，则搜索不到；  
> > 3、输入框上方会显示已添加的审批人，如果需要修改，可以点击右方「X」删除对应审批人；

##### 3. 通知配置

> 配置步骤

a. _**打开审批消息配置**_

![审批消息配置-打开](http://wiki.qudian.com/download/attachments/38234935/%E5%AE%A1%E6%89%B9%E6%B6%88%E6%81%AF%E9%85%8D%E7%BD%AE-%E6%89%93%E5%BC%80.png?version=1&modificationDate=1569227194000&api=v2)

b. _**添加审批配置**_

![审批消息配置-添加](http://wiki.qudian.com/download/attachments/38234935/%E5%AE%A1%E6%89%B9%E6%B6%88%E6%81%AF%E9%85%8D%E7%BD%AE-%E6%B7%BB%E5%8A%A0.png?version=1&modificationDate=1569227194000&api=v2)

c. _**审批消息配置模版详情**_  
![](http://image.clickear.top/20220913122929.png)

d. _**事件类型**_  
![](http://image.clickear.top/20220913122918.png)

> 默认配置

![](http://image.clickear.top/20220913122904.png)

> 可用参数说明

- startUserName:流程实例发起人
    
- processDefinitionName：流程实例定义名
    
- commentOperator：评论发起人
    
- setAssigneeOperator：转交发起人
    

> 支持自定义

在创建流程实例时，将参数作为form表单的值传入，在通知配置可使用 自行传入的参数

```

https://${"flowHost"}/api/process/instance

body:
{
  "definitionKey":"financeNamePlanProcess",
  "formValues":{
    "businessKey":"2",
    "capitalName":"参数值我是参数值"
  }
}

模板：
我是测试的模板，测试的值是：${capitalName}
  
结果：
我是测试的模板，测试的值是：参数值我是参数值
  
支持默认值：
我是测试的模板，测试的值是：${capitalName:-设置的默认值}
  
capitalName未找到，则结果为：
我是测试的模板，测试的值是：设置的默认值

```

##### 4. 回调配置

> 在工作流创建流程实例、审批节点、流程实例结束时，都会触发相关事件，系统会根据配置回调第三方业务系统接口地址。

> 配置步骤

a. _**打开回调地址配置**_

![回调地址配置-打开](http://wiki.qudian.com/download/attachments/38234935/%E5%9B%9E%E8%B0%83%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE-%E6%89%93%E5%BC%80.png?version=1&modificationDate=1569227193000&api=v2)

b. _**添加审批配置**_

![回调地址配置-添加](http://wiki.qudian.com/download/attachments/38234935/%E5%9B%9E%E8%B0%83%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE-%E6%96%B0%E5%A2%9E.png?version=1&modificationDate=1569227193000&api=v2)

c. _**审批消息配置模版详情**_

![回调地址配置模版详情](http://wiki.qudian.com/download/attachments/38234935/%E5%9B%9E%E8%B0%83%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE%E6%A8%A1%E7%89%88%E8%AF%A6%E6%83%85.png?version=1&modificationDate=1569227193000&api=v2)

d. _**事件类型**_

![回调地址配置-事件类型](http://wiki.qudian.com/download/attachments/38234935/%E5%9B%9E%E8%B0%83%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE-%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B.png?version=1&modificationDate=1569227193000&api=v2)

> 配置字段说明

> > 事件说明

![](http://image.clickear.top/20220913123531.png)

> > 回调地址URL

- 必填项

> > 是否允许异步

- true:表示回调操作会异步执行，若有报错审批操作仍然正常结束，不会进行回滚。一般用在回调操作比较不重要的场景，比如发送钉钉消息
    
- false:表示回调操作在节点完成之后同步调用，若有报错会回滚包括审批在内的操作。如果回调操作比较重要，建议设置为false
    

#### 关联表单

### 部署

![image-20190911164452486](http://wiki.qudian.com/pages/resources/leaveFormApp.png)

![](http://wiki.qudian.com/download/attachments/38234935/leaveFormApp.png?version=1&modificationDate=1568200789000&api=v2)

1. 创建应用
2. 将流程加入到应用中
3. 发布应用即进行部署

## 权限控制

> 普通用户

- 普通用户只能查看到自己创建的流程和表单等信息

> 超级管理员

- 管理员可以看到所有的流程和表单数据
- 规定管理员id以admin开头

## 业务方边界

### 什么时候用自定义表单

> 工作流提供了简单的一套表单引擎解析。该表单引擎功能比较单一，即支持一些简单的格式。如果业务系统仅仅使用流程引擎的流转能力，不需要表单功能，相关的审批页面在业务系统中，则可以不支持该接口功能。需要相关的流程走向视图，可调用[流程走向视图接口](http://wiki.qudian.com/pages/[http://wiki.qudian.com/pages/viewpage.action?pageId=33532255#id-%E5%B7%A5%E4%BD%9C%E6%B5%81%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3-%E4%BB%BB%E5%8A%A1%E5%88%97%E8%A1%A8%EF%BC%88%E5%8C%85%E5%90%AB%E6%B5%81%E7%A8%8B%E6%9C%AA%E8%B5%B0%E5%88%B0%E7%9A%84%E4%BB%BB%E5%8A%A1%E7%BB%93%E6%9E%84%EF%BC%89](http://wiki.qudian.com/pages/viewpage.action?pageId=33532255#id-%E5%B7%A5%E4%BD%9C%E6%B5%81%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3-%E4%BB%BB%E5%8A%A1%E5%88%97%E8%A1%A8%EF%BC%88%E5%8C%85%E5%90%AB%E6%B5%81%E7%A8%8B%E6%9C%AA%E8%B5%B0%E5%88%B0%E7%9A%84%E4%BB%BB%E5%8A%A1%E7%BB%93%E6%9E%84%EF%BC%89))进行渲染。

提供了3种方式，可根据需求获取

1. 使用工作流表单 + 工作流
2. 使用业务系统自身的表单(将表单值注入到工作流上下文中) + 工作流
3. 需要审批的字段使用工作流表单 + 工作流

工作流表单不足:

- 支持控件类型较少，但基本满足简单场景
- 审批过程中，不支持编辑

![image-20190911192707934](http://wiki.qudian.com/pages/resources/form.png)

### 业务接口回调

> 业务接口回调，是指一些重要节点的审批操作之后，业务系统需要执行某些操作。这里可以通过事件回调功能，工作流系统调用业务系统进行接口调用。
>
> 这里需要注意的事，钉钉消息属于工作流通用功能。业务方系统可不用再发送钉钉消息

## FAQ

### 申请人和提交人的区别？

### 是否需要使用表单？

### 测试环境搭建好的流程，如何快速导入到正式环境？

> 可通过在测试环境导出流程配置，正式环境导入流程配置的方式进行配置。由于使用官方的导入功能，导入即包括表单定义和流程定义。不包括任务配置、审批人配置、通知配置、回调配置等信息。需要在生成环境进行配置。

1. 测试环境将整个应用导成zip文件

![](http://wiki.qudian.com/pages/resources/export.png)

2. 正式环境导入

![](http://wiki.qudian.com/pages/resources/import.png)

3. 修改节点配置、审批人配置等()

## 路线图

- 完善使用文档，工作流术语 20190911
- 完善配置清单、使用case 20190912
- 完善节点扩展配置功能
- 完善审批人配置功能
- 完善通知配置功能
- 完善回调配置功能
- 校验配置完整性功能
- app权限控制

# 任务拆解

功能模块

研发任务

研发人员

预计工时

flowable-modeler项目初始环境搭建、打成war包

李耀东

1.5

完善节点扩展配置功能

陈若晨

1.5

完善审批人配置功能(固定审批人、申请人、提交人、API接口)

周豪

2.5

完善通知配置功能

李耀东

1

完善回调配置功能

李耀东

1

校验配置完整性功能

2

优化流程配置默认值

1.5

数据权限控制

3

使用文档完善

2.5

后续规划

- 编辑器可视化
- 导入导出功能优化
